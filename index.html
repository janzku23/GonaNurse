<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>L√§√§kelistan harjoittelu ‚Äì Lifecare-tyyli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #e5e9f0;
      --card-bg: #ffffff;
      --border: #cbd5e1;
      --header-bg: #204d8c;
      --header-text: #ffffff;
      --row-alt: #f8fafc;
      --accent: #2563eb;
      --danger: #b91c1c;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #dbe4f0, #eef2f7);
      color: var(--text-main);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.35rem;
      margin-bottom: 4px;
      letter-spacing: 0.02em;
      color: #111827;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
      margin-bottom: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .card-title {
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #1f2937;
    }

    .card-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      white-space: nowrap;
    }

    .card-body {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: pre-line;
    }

    .table-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .table-card-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #111827;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      font-size: 0.78rem;
      padding: 5px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s ease, transform 0.05s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(37, 99, 235, 0.4);
    }

    .btn-ghost:hover {
      background: rgba(37, 99, 235, 0.05);
    }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 0.9rem;
    }

    .btn-icon:hover {
      background: rgba(185, 28, 28, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.72rem;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
      table-layout: fixed;
    }

    thead {
      background: var(--header-bg);
      color: var(--header-text);
    }

    thead th {
      padding: 4px 6px;
      text-align: left;
      font-weight: 500;
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    thead th:last-child {
      border-right: none;
      text-align: center;
    }

    tbody tr:nth-child(odd) {
      background: #fefefe;
    }

    tbody tr:nth-child(even) {
      background: var(--row-alt);
    }

    tbody td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .med-input {
      width: 100%;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(255, 255, 255, 0.96);
      font-size: 0.7rem;
      padding: 2px 4px;
    }

    .med-input[readonly] {
      background: #e5e7eb;
      color: #4b5563;
    }

    .dose-slot-input {
      width: 100%;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(255, 255, 255, 0.96);
      font-size: 0.7rem;
      padding: 2px 0;
      text-align: center;
    }

    .feedback {
      margin-top: 8px;
      font-size: 0.78rem;
      padding: 6px 8px;
      border-radius: 6px;
      display: none;
    }

    .feedback.ok {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .feedback.warn {
      background: #fef9c3;
      color: #854d0e;
      border: 1px solid #facc15;
    }

    .footer {
      margin-top: 10px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.72rem;
      }

      thead {
        display: none;
      }

      table, tbody, tr, td {
        display: block;
        width: 100%;
      }

      tbody tr {
        margin-bottom: 8px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 6px;
      }

      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        margin-right: 6px;
        color: var(--text-muted);
        min-width: 90px;
      }

      .btn-icon {
        margin-left: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>L√§√§kelistan harjoittelu (Lifecare-tyyli)</h1>
    <div class="subtitle">
      Harjoitusymp√§rist√∂ ‚Äì ei oikeita potilastietoja. Tee l√§√§kelista l√§√§k√§rin tekstin mukaan ja etene uusiin m√§√§r√§yksiin p√§iv√§ kerrallaan.
    </div>

    <!-- M√Ñ√ÑR√ÑYS / TEHT√ÑV√ÑNANTO -->
    <div class="card" id="task-card">
      <div class="card-header">
        <div class="card-title" id="task-title"></div>
        <div class="card-badge" id="task-badge"></div>
      </div>
      <div class="card-body" id="task-description"></div>
    </div>

    <!-- L√Ñ√ÑKELISTA -->
    <div class="card">
      <div class="table-card-header">
        <div class="table-card-title">L√§√§kelista</div>
        <button class="btn btn-ghost" id="add-med-btn">
          Ôºã Lis√§√§ l√§√§kerivi
        </button>
      </div>

      <div class="table-wrapper">
        <table id="med-table">
          <thead>
            <tr>
              <th style="width: 9%;">Tyyppi</th>
              <th style="width: 10%;">Aikav√§li</th>
              <th style="width: 18%;">L√§√§ke</th>
              <th style="width: 9%;">Vahvuus</th>
              <th style="width: 9%;">Muoto</th>
              <th style="width: 11%;">Annostus</th>
              <th>AY</th>
              <th>A</th>
              <th>AP</th>
              <th>P</th>
              <th>IP</th>
              <th>I</th>
              <th>Y</th>
              <th style="width: 5%;">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="med-tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        L√§√§kkeen nimen valinta t√§ytt√§√§ vahvuuden ja muodon automaattisesti, jos valmiste l√∂ytyy luettelosta.  
        AY, A, AP, P, IP, I, Y: merkitse tablettim√§√§r√§ (esim. 1, 0,5) tai <strong>injektioilla my√∂s vahvuus, esim. "40 mg"</strong>.  
        Huom: jos sy√∂t√§t pelk√§n luvun (esim. 40) vahvuutena, t√§ytyy mukana olla my√∂s yksikk√∂ (mg tai g).
      </div>

      <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
        <button class="btn btn-primary" id="check-btn">
          ‚úÖ Tarkista t√§m√§ teht√§v√§
        </button>
        <button class="btn btn-ghost" id="next-btn" style="display:none;">
          Seuraava m√§√§r√§ys ‚ñ∂Ô∏é
        </button>
        <button class="btn btn-ghost" id="reset-btn">
          Palauta alkuper√§inen tila
        </button>
      </div>

      <div id="feedback" class="feedback"></div>
    </div>
  </div>

  <!-- L√Ñ√ÑKELUETTELO (HAKU) -->
  <datalist id="medications-list"></datalist>

  <script>
    // ---------- Apufunktiot annoksen normalisointiin ----------

    function normDoseString(s) {
      return (s || "")
        .toLowerCase()
        .replace(",", ".")
        .replace(/\s*/g, ""); // poistaa kaikki v√§lily√∂nnit ‚Üí "1x1", "0.5x1-3vrk"
    }

    // ---------- L√Ñ√ÑKEKATALOGI ----------

    const MEDICATIONS = [
      { code: "PANADOL_1G_TAB",   name: "Panadol 1 g tabletti",               strength: "1 g",         form: "tabletti" },
      { code: "PANADOL_500_TAB",  name: "Panadol 500 mg tabletti",            strength: "500 mg",      form: "tabletti" },
      { code: "BURANA_400_TAB",   name: "Burana 400 mg tabletti",             strength: "400 mg",      form: "tabletti" },
      { code: "MAREVAN_3_TAB",    name: "Marevan 3 mg tabletti",              strength: "3 mg",        form: "tabletti" },
      { code: "METFOREM_500",     name: "Metforem 500 mg tabletti",           strength: "500 mg",      form: "tabletti" },
      { code: "LANTUS_SOLO",      name: "Lantus SoloStar 100 IU/ml inj s.c.", strength: "100 IU/ml",   form: "injektio s.c." },
      { code: "SERTRALIN_50",     name: "Sertralin Orion 50 mg tabletti",     strength: "50 mg",       form: "tabletti" },
      { code: "CIPRALEX_10",      name: "Cipralex 10 mg tabletti",            strength: "10 mg",       form: "tabletti" },
      { code: "SIMVA_20",         name: "Simvastatin Orion 20 mg tabl.",      strength: "20 mg",       form: "tabletti" },
      { code: "ATORVA_40",        name: "Atorvastatin Krka 40 mg tabl.",      strength: "40 mg",       form: "tabletti" },
      { code: "PRIMPERAN_IV",     name: "Primperan 10 mg/ml inj i.v.",        strength: "10 mg/ml",    form: "injektio i.v." },
      { code: "VOLTAREN_IM",      name: "Voltaren 75 mg inj i.m.",            strength: "75 mg",       form: "injektio i.m." },
      { code: "KLEXANE_40_SC",    name: "Klexane 40 mg/0,4 ml inj s.c.",      strength: "40 mg/0,4 ml",form: "injektio s.c." }
    ];

    // ---------- TEHT√ÑV√ÑT ----------

    const TASKS = [
      {
        title: "Teht√§v√§ 1 ‚Äì Tee l√§√§kelista l√§√§k√§rin tekstin mukaan (p√§iv√§ 1)",
        description: `L√§√§k√§rin teksti (p√§iv√§ 1):

72-vuotias potilas, jolla tyypin 2 diabetes ja eteisv√§rin√§.
Jatketaan seuraavaa s√§√§nn√∂llist√§ (jatkuvaa) l√§√§kityst√§:

‚Ä¢ Metforem 500 mg tabletti 1 x 2 p.o. (aamulla ja illalla)
‚Ä¢ Marevan 3 mg tabletti 1 x 1 p.o. iltaisin
‚Ä¢ Lantus SoloStar 100 IU/ml inj s.c. 20 IU iltaisin

Teht√§v√§:
1. Tee l√§√§kelista yll√§ olevan tekstin mukaisesti.
   ‚Äì Lis√§√§ Metforem, Marevan ja Lantus SoloStar listalle.
2. Merkitse tyypiksi "Jatkuva".
3. Annostus:
   ‚Äì Metforem: annostus 1 x 2 (my√∂s "1x2" hyv√§ksyt√§√§n), AY‚ÄìY-jaossa 1 A ja 1 I
   ‚Äì Marevan: annostus 1 x 1 ("1x1") iltaisin, AY‚ÄìY-jaossa 1 I
   ‚Äì Lantus: annostus esim. "20 IU s.c. 1 x 1"; AY‚ÄìY-jakoa ei tarkisteta Lantuksen osalta.
4. Tarkista teht√§v√§. Onnistuneen tarkistuksen j√§lkeen voit siirty√§ seuraavaan m√§√§r√§ykseen.`
      },
      {
        title: "Teht√§v√§ 2 ‚Äì Uusi m√§√§r√§ys: parasetamoli (p√§iv√§ 2)",
        description: `L√§√§k√§rin teksti (p√§iv√§ 2):

Potilaalla on ollut leikkauksen j√§lkeen kohtalaista kipua.
Lis√§t√§√§n tarvittaessa k√§ytett√§v√§ parasetamoli:

‚Ä¢ Parasetamoli 500 mg p.o. tarvittaessa kipuun, 1 x 1 (aamu)

Osastolla k√§ytett√§viss√§:
‚Ä¢ Panadol 1 g tabletti
‚Ä¢ Panadol 500 mg tabletti

Teht√§v√§:
1. Perusl√§√§kitys (Metforem, Marevan, Lantus) s√§ilyy ennallaan ja oikein merkittyn√§ (Jatkuva).
2. Lis√§√§ parasetamoli m√§√§r√§yksen mukaisesti tyypill√§ "Tarvittava" jommalla kummalla tavalla:
   ‚Äì Panadol 1 g tabletti
     ‚Ä¢ annostus: 0,5 x 1 (my√∂s "0,5x1" hyv√§ksyt√§√§n)
     ‚Ä¢ AY‚ÄìY-jako: 0,5 A
     TAI
   ‚Äì Panadol 500 mg tabletti
     ‚Ä¢ annostus: 1 x 1 ("1x1")
     ‚Ä¢ AY‚ÄìY-jako: 1 A
3. Tarkista teht√§v√§. Kun se on oikein, siirry seuraavaan m√§√§r√§ykseen.`
      },
      {
        title: "Teht√§v√§ 3 ‚Äì Uusi m√§√§r√§ys: pahoinvointi ja lis√§kipu (i.v. + i.m.) (p√§iv√§ 3)",
        description: `L√§√§k√§rin teksti (p√§iv√§ 3):

Potilaalla on esiintynyt leikkauksen j√§lkeen pahoinvointia ja ajoittaista kovempaa kipua.
Lis√§t√§√§n tarvittaessa k√§ytett√§v√§t injektiol√§√§kkeet:

‚Ä¢ Primperan 10 mg i.v. tarvittaessa pahoinvointiin, 1 x 1‚Äì3 vrk
‚Ä¢ Voltaren 75 mg i.m. tarvittaessa kipuun, 1 x 1‚Äì2 vrk

Osastolla k√§ytett√§viss√§ olevat valmisteet:
‚Ä¢ Primperan 10 mg/ml inj i.v.
‚Ä¢ Voltaren 75 mg inj i.m.

Teht√§v√§:
1. Perusl√§√§kitys ja parasetamoli ovat edelleen voimassa ja oikein.
2. Lis√§√§ l√§√§kelistalle:
   ‚Äì Primperan 10 mg/ml inj i.v., tyyppi "Tarvittava"
     ‚Ä¢ annostus: 1 x 1‚Äì3 vrk (my√∂s "1x1-3vrk" hyv√§ksyt√§√§n)
   ‚Äì Voltaren 75 mg inj i.m., tyyppi "Tarvittava"
     ‚Ä¢ annostus: 1 x 1‚Äì2 vrk (my√∂s "1x1-2vrk" hyv√§ksyt√§√§n)
3. AY‚ÄìY-jakoa ei vaadita tarkasti n√§ille tarvittaessa injektioille t√§ss√§ teht√§v√§ss√§,
   mutta niiden tulee l√∂yty√§ listalta oikealla nimell√§, vahvuudella ja muodolla.`
      },
      {
        title: "Teht√§v√§ 4 ‚Äì Uusi m√§√§r√§ys: tromboosiprofylaksia s.c. (p√§iv√§ 4)",
        description: `L√§√§k√§rin teksti (p√§iv√§ 4):

Potilaalla on lis√§√§ntynyt laskimotukosriski toipumisvaiheen aikana.
Lis√§t√§√§n tromboosiprofylaksia:

‚Ä¢ Klexane 40 mg s.c. 1 x 1 iltaisin

Osastolla k√§ytett√§viss√§:
‚Ä¢ Klexane 40 mg/0,4 ml inj s.c.

Teht√§v√§:
1. Kaikki aiemmat l√§√§kkeet (Metforem, Marevan, Lantus, tarvittaessa Panadol, Primperan, Voltaren) s√§ilyv√§t oikein.
2. Lis√§√§ l√§√§kelistalle Klexane 40 mg/0,4 ml inj s.c., tyyppi "Jatkuva".
   ‚Äì annostus: esim. "40 mg/0,4 ml 1 x 1 s.c."
   ‚Äì AY‚ÄìY-jako: iltaan (I), voit merkit√§ joko:
     ‚Ä¢ "1" tai
     ‚Ä¢ "40 mg" (tai vastaava, jossa on aina mg- tai g-yksikk√∂ mukana, ei pelkk√§ numero).
3. Tarkista teht√§v√§. Kun kaikki on oikein, koko harjoitussarja on suoritettu.`
      }
    ];

    const INITIAL_LIST = []; // aloitetaan tyhj√§ll√§ l√§√§kelistalla

    // ---------- TAVOITE-ARVOT ----------

    const targetMetforem = {
      drugName: "metforem 500 mg tabletti",
      strength: "500 mg",
      form: "tabletti",
      dose: normDoseString("1 x 2"),
      a: "1",
      i: "1"
    };

    const targetMarevan = {
      drugName: "marevan 3 mg tabletti",
      strength: "3 mg",
      form: "tabletti",
      dose: normDoseString("1 x 1"),
      i: "1"
    };

    const targetLantus = {
      drugName: "lantus solostar 100 iu/ml inj s.c.",
      strength: "100 iu/ml",
      form: "injektio s.c."
    };

    const targetPanadol1g = {
      drugName: "panadol 1 g tabletti",
      strength: "1 g",
      form: "tabletti",
      dose: normDoseString("0,5 x 1"),
      a: "0.5"
    };

    const targetPanadol500 = {
      drugName: "panadol 500 mg tabletti",
      strength: "500 mg",
      form: "tabletti",
      dose: normDoseString("1 x 1"),
      a: "1"
    };

    // ---------- SOVELLUSLOGIIKKA ----------

    let meds = JSON.parse(JSON.stringify(INITIAL_LIST));
    let currentTaskIndex = 0;
    let lastCheckOK = false;

    const taskTitleEl = document.getElementById("task-title");
    const taskBadgeEl = document.getElementById("task-badge");
    const taskDescriptionEl = document.getElementById("task-description");

    const tbody = document.getElementById("med-tbody");
    const addMedBtn = document.getElementById("add-med-btn");
    const checkBtn = document.getElementById("check-btn");
    const nextBtn = document.getElementById("next-btn");
    const resetBtn = document.getElementById("reset-btn");
    const feedbackEl = document.getElementById("feedback");
    const datalistEl = document.getElementById("medications-list");

    // T√§yt√§ datalist
    MEDICATIONS.forEach(med => {
      const opt = document.createElement("option");
      opt.value = med.name;
      datalistEl.appendChild(opt);
    });

    function renderTask() {
      const t = TASKS[currentTaskIndex];
      taskTitleEl.textContent = t.title;
      taskDescriptionEl.textContent = t.description;
      taskBadgeEl.textContent = `Teht√§v√§ ${currentTaskIndex + 1} / ${TASKS.length}`;
    }

    function findMedicationByName(name) {
      const trimmed = (name || "").trim().toLowerCase();
      return MEDICATIONS.find(m => m.name.toLowerCase() === trimmed) || null;
    }

    function ensureScheduleFields(med) {
      const keys = ["ay", "a", "ap", "p", "ip", "i", "y"];
      keys.forEach(k => {
        if (typeof med[k] === "undefined") med[k] = "";
      });
      if (typeof med.type === "undefined") med.type = "Jatkuva";
      if (typeof med.period === "undefined") med.period = "";
      return med;
    }

    function renderMedTable() {
      tbody.innerHTML = "";
      meds.forEach((med, index) => {
        ensureScheduleFields(med);
        const tr = document.createElement("tr");

        const createInputCell = (label, value, onInput, options = {}) => {
          const td = document.createElement("td");
          td.setAttribute("data-label", label);
          const input = document.createElement("input");
          input.className = "med-input";
          input.value = value || "";
          if (options.readonly) input.readOnly = true;
          if (options.datalist) input.setAttribute("list", options.datalist);
          input.addEventListener("input", (e) => {
            onInput(e.target.value);
          });
          if (options.onBlur) {
            input.addEventListener("blur", (e) => options.onBlur(e.target.value));
          }
          td.appendChild(input);
          return td;
        };

        const createDoseCell = (label, key) => {
          const td = document.createElement("td");
          td.setAttribute("data-label", label);
          const input = document.createElement("input");
          input.className = "dose-slot-input";
          input.value = med[key] || "";
          input.addEventListener("input", (e) => {
            meds[index][key] = e.target.value;
          });
          td.appendChild(input);
          return td;
        };

        // Tyyppi (Jatkuva / Tarvittava / M√§√§r√§aikainen)
        const tdType = document.createElement("td");
        tdType.setAttribute("data-label", "Tyyppi");
        const sel = document.createElement("select");
        sel.className = "med-input";
        ["Jatkuva", "Tarvittava", "M√§√§r√§aikainen"].forEach(optVal => {
          const o = document.createElement("option");
          o.value = optVal;
          o.textContent = optVal;
          if (med.type === optVal) o.selected = true;
          sel.appendChild(o);
        });
        sel.addEventListener("change", e => {
          meds[index].type = e.target.value;
        });
        tdType.appendChild(sel);
        tr.appendChild(tdType);

        // Aikav√§li (tekstikentt√§, esim. "1‚Äì3 vrk")
        tr.appendChild(
          createInputCell(
            "Aikav√§li",
            med.period || "",
            (val) => { meds[index].period = val; }
          )
        );

        // L√§√§ke
        const drugCell = createInputCell(
          "L√§√§ke",
          med.drugName || "",
          (val) => { meds[index].drugName = val; },
          {
            datalist: "medications-list",
            onBlur: (val) => {
              const match = findMedicationByName(val);
              if (match) {
                meds[index].medCode = match.code;
                meds[index].drugName = match.name;
                meds[index].strength = match.strength;
                meds[index].form = match.form;
                renderMedTable();
              } else {
                meds[index].medCode = null;
              }
            }
          }
        );
        tr.appendChild(drugCell);

        const isKnown = !!med.medCode;

        // Vahvuus
        tr.appendChild(
          createInputCell(
            "Vahvuus",
            med.strength || "",
            (val) => { if (!isKnown) meds[index].strength = val; },
            { readonly: isKnown }
          )
        );

        // Muoto
        tr.appendChild(
          createInputCell(
            "Muoto",
            med.form || "",
            (val) => { if (!isKnown) meds[index].form = val; },
            { readonly: isKnown }
          )
        );

        // Annostus
        tr.appendChild(
          createInputCell(
            "Annostus",
            med.dose || "",
            (val) => { meds[index].dose = val; }
          )
        );

        // AY‚ÄìY
        tr.appendChild(createDoseCell("AY", "ay"));
        tr.appendChild(createDoseCell("A", "a"));
        tr.appendChild(createDoseCell("AP", "ap"));
        tr.appendChild(createDoseCell("P", "p"));
        tr.appendChild(createDoseCell("IP", "ip"));
        tr.appendChild(createDoseCell("I", "i"));
        tr.appendChild(createDoseCell("Y", "y"));

        // Poisto
        const tdDelete = document.createElement("td");
        tdDelete.setAttribute("data-label", "Poista");
        tdDelete.style.textAlign = "center";
        const delBtn = document.createElement("button");
        delBtn.className = "btn-icon";
        delBtn.innerHTML = "üóë";
        delBtn.title = "Poista rivi";
        delBtn.addEventListener("click", () => {
          meds.splice(index, 1);
          renderMedTable();
        });
        tdDelete.appendChild(delBtn);
        tr.appendChild(tdDelete);

        tbody.appendChild(tr);
      });
    }

    function renderAll() {
      renderMedTable();
      updateNextButtonVisibility();
    }

    function normalizeRow(m) {
      const normNum = (v) => (v || "").trim().replace(",", ".");
      return {
        drugName: (m.drugName || "").trim().toLowerCase(),
        strength: (m.strength || "").trim().toLowerCase(),
        form: (m.form || "").trim().toLowerCase(),
        dose: normDoseString(m.dose),
        ay: normNum(m.ay),
        a: normNum(m.a),
        ap: normNum(m.ap),
        p: normNum(m.p),
        ip: normNum(m.ip),
        i: normNum(m.i),
        y: normNum(m.y),
        type: (m.type || "").trim(),
        period: (m.period || "").trim()
      };
    }

    function showFeedback(message, ok) {
      feedbackEl.textContent = message;
      feedbackEl.classList.remove("ok", "warn");
      feedbackEl.classList.add(ok ? "ok" : "warn");
      feedbackEl.style.display = "block";
    }

    function updateNextButtonVisibility() {
      if (lastCheckOK && currentTaskIndex < TASKS.length - 1) {
        nextBtn.style.display = "inline-flex";
      } else {
        nextBtn.style.display = "none";
      }
    }

    // ---------- TARKISTUSFUNKTIOt ----------

    function checkBaseMeds(rows) {
      // Metforem
      const met = rows.find(r => r.drugName === targetMetforem.drugName);
      if (!met) {
        showFeedback("Metforem 500 mg tabletti puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        met.strength !== targetMetforem.strength.toLowerCase() ||
        met.form !== targetMetforem.form.toLowerCase() ||
        met.dose !== targetMetforem.dose ||
        met.a !== targetMetforem.a ||
        met.i !== targetMetforem.i
      ) {
        showFeedback("Metforem ei ole oikein. Sen tulee olla 1 x 2 (my√∂s 1x2 k√§y) ja AY‚ÄìY-jaossa 1 A ja 1 I.", false);
        return false;
      }

      // Marevan
      const mare = rows.find(r => r.drugName === targetMarevan.drugName);
      if (!mare) {
        showFeedback("Marevan 3 mg tabletti puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        mare.strength !== targetMarevan.strength.toLowerCase() ||
        mare.form !== targetMarevan.form.toLowerCase() ||
        mare.dose !== targetMarevan.dose ||
        mare.i !== targetMarevan.i
      ) {
        showFeedback("Marevan ei ole oikein. Sen tulee olla 1 x 1 (1x1) iltaisin ja AY‚ÄìY-jaossa 1 I.", false);
        return false;
      }

      // Lantus
      const lantus = rows.find(r => r.drugName === targetLantus.drugName);
      if (!lantus) {
        showFeedback("Lantus SoloStar 100 IU/ml inj s.c. puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        lantus.strength !== targetLantus.strength.toLowerCase() ||
        lantus.form !== targetLantus.form.toLowerCase()
      ) {
        showFeedback("Lantus ei ole oikein (vahvuus tai muoto ei t√§sm√§√§).", false);
        return false;
      }

      return true;
    }

    function checkPanadol(rows) {
      const pans = rows.filter(r =>
        r.drugName.startsWith("panadol") && r.form === "tabletti"
      );

      if (pans.length === 0) {
        showFeedback("Panadol/parasetamoli ei l√∂ydy l√§√§kelistalta.", false);
        return false;
      }

      const ok1g = pans.some(p =>
        p.drugName === targetPanadol1g.drugName &&
        p.strength === targetPanadol1g.strength.toLowerCase() &&
        p.dose === targetPanadol1g.dose &&
        p.a === targetPanadol1g.a
      );

      const ok500 = pans.some(p =>
        p.drugName === targetPanadol500.drugName &&
        p.strength === targetPanadol500.strength.toLowerCase() &&
        p.dose === targetPanadol500.dose &&
        p.a === targetPanadol500.a
      );

      if (!ok1g && !ok500) {
        showFeedback(
          "Panadol ei ole oikein. Hyv√§ksyt√§√§n joko:\n" +
          "‚Ä¢ Panadol 1 g tabletti, annos 0,5 x 1 (0,5x1) ja AY‚ÄìY-jaossa 0,5 A\n" +
          "  TAI\n" +
          "‚Ä¢ Panadol 500 mg tabletti, annos 1 x 1 (1x1) ja AY‚ÄìY-jaossa 1 A.",
          false
        );
        return false;
      }

      return true;
    }

    function checkIVandIM(rows) {
      const prim = rows.find(r =>
        r.drugName === "primperan 10 mg/ml inj i.v." &&
        r.strength === "10 mg/ml" &&
        r.form === "injektio i.v."
      );
      if (!prim) {
        showFeedback("Primperan 10 mg/ml inj i.v. puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (prim.dose !== normDoseString("1 x 1-3 vrk")) {
        showFeedback("Primperan annostus ei ole oikein. Sen tulee olla 1 x 1‚Äì3 vrk (my√∂s 1x1-3vrk hyv√§ksyt√§√§n).", false);
        return false;
      }

      const volt = rows.find(r =>
        r.drugName === "voltaren 75 mg inj i.m." &&
        r.strength === "75 mg" &&
        r.form === "injektio i.m."
      );
      if (!volt) {
        showFeedback("Voltaren 75 mg inj i.m. puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (volt.dose !== normDoseString("1 x 1-2 vrk")) {
        showFeedback("Voltaren annostus ei ole oikein. Sen tulee olla 1 x 1‚Äì2 vrk (my√∂s 1x1-2vrk hyv√§ksyt√§√§n).", false);
        return false;
      }

      return true;
    }

    function checkKlexane(rows) {
      const klex = rows.find(r =>
        r.drugName === "klexane 40 mg/0,4 ml inj s.c." &&
        r.strength === "40 mg/0,4 ml" &&
        r.form === "injektio s.c."
      );
      if (!klex) {
        showFeedback("Klexane 40 mg/0,4 ml inj s.c. puuttuu l√§√§kelistalta.", false);
        return false;
      }

      const iVal = (klex.i || "").trim().toLowerCase();

      // Hyv√§ksyt√§√§n joko "1" TAI teksti, jossa on mg- tai g-yksikk√∂ mukana (esim. "40 mg", "40mg").
      if (!(iVal === "1" || /mg|g/.test(iVal))) {
        showFeedback("Klexanen I-sarakkeessa tulee olla joko \"1\" TAI vahvuus, jossa on mg- tai g-yksikk√∂ (esim. \"40 mg\").", false);
        return false;
      }

      return true;
    }

    // ---------- TEHT√ÑV√ÑKOHTAINEN TARKISTUS ----------

    function checkCurrentTask() {
      const rows = meds
        .map(m => ensureScheduleFields(m))
        .map(m => normalizeRow(m))
        .filter(r => r.drugName || r.strength || r.dose);

      if (rows.length === 0) {
        showFeedback("L√§√§kelista on tyhj√§. Lis√§√§ l√§√§kkeet l√§√§k√§rin tekstin mukaisesti.", false);
        return false;
      }

      switch (currentTaskIndex) {
        case 0: { // perusl√§√§kitys
          if (!checkBaseMeds(rows)) return false;
          showFeedback("Teht√§v√§ 1 suoritettu oikein. Voit siirty√§ seuraavaan m√§√§r√§ykseen.", true);
          return true;
        }
        case 1: { // perusl√§√§kitys + Panadol
          if (!checkBaseMeds(rows)) return false;
          if (!checkPanadol(rows)) return false;
          showFeedback("Teht√§v√§ 2 suoritettu oikein (perusl√§√§kitys + parasetamoli). Voit siirty√§ seuraavaan m√§√§r√§ykseen.", true);
          return true;
        }
        case 2: { // perusl√§√§kitys + Panadol + i.v./i.m.
          if (!checkBaseMeds(rows)) return false;
          if (!checkPanadol(rows)) return false;
          if (!checkIVandIM(rows)) return false;
          showFeedback("Teht√§v√§ 3 suoritettu oikein (lis√§tty Primperan i.v. ja Voltaren i.m. oikeilla annoksilla). Voit siirty√§ seuraavaan m√§√§r√§ykseen.", true);
          return true;
        }
        case 3: { // kaikki + Klexane
          if (!checkBaseMeds(rows)) return false;
          if (!checkPanadol(rows)) return false;
          if (!checkIVandIM(rows)) return false;
          if (!checkKlexane(rows)) return false;
          showFeedback("Teht√§v√§ 4 ja koko harjoitussarja suoritettu oikein. Hienoa ty√∂t√§! ‚úÖ", true);
          return true;
        }
        default:
          return false;
      }
    }

    // ---------- RESET & NAVIGOINTI ----------

    function resetList() {
      meds = JSON.parse(JSON.stringify(INITIAL_LIST));
      lastCheckOK = false;
      feedbackEl.style.display = "none";
      renderAll();
    }

    // ---------- TAPAHTUMAT ----------

    addMedBtn.addEventListener("click", () => {
      meds.push({
        medCode: null,
        type: "Jatkuva",
        period: "",
        drugName: "",
        strength: "",
        form: "",
        dose: "",
        ay: "", a: "", ap: "", p: "", ip: "", i: "", y: ""
      });
      renderMedTable();
    });

    checkBtn.addEventListener("click", () => {
      const ok = checkCurrentTask();
      lastCheckOK = ok;
      updateNextButtonVisibility();
    });

    nextBtn.addEventListener("click", () => {
      if (!lastCheckOK) return;
      if (currentTaskIndex < TASKS.length - 1) {
        currentTaskIndex++;
        lastCheckOK = false;
        feedbackEl.style.display = "none";
        renderTask();
        updateNextButtonVisibility();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    resetBtn.addEventListener("click", () => {
      resetList();
    });

    // ---------- INIT ----------

    (function init() {
      renderTask();
      renderAll();
    })();
  </script>
</body>
</html>
