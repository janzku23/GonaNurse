<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>L√§√§kelistan harjoittelu ‚Äì Lifecare-tyyli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #e5e9f0;
      --card-bg: #ffffff;
      --border: #cbd5e1;
      --header-bg: #204d8c;
      --header-text: #ffffff;
      --row-alt: #f8fafc;
      --accent: #2563eb;
      --danger: #b91c1c;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #dbe4f0, #eef2f7);
      color: var(--text-main);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.35rem;
      margin-bottom: 4px;
      letter-spacing: 0.02em;
      color: #111827;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
      margin-bottom: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .card-title {
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #1f2937;
    }

    .card-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      white-space: nowrap;
    }

    .card-body {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: pre-line;
    }

    .table-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .table-card-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #111827;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      font-size: 0.78rem;
      padding: 5px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s ease, transform 0.05s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(37, 99, 235, 0.4);
    }

    .btn-ghost:hover {
      background: rgba(37, 99, 235, 0.05);
    }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 0.9rem;
    }

    .btn-icon:hover {
      background: rgba(185, 28, 28, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.72rem;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
      table-layout: fixed;
    }

    thead {
      background: var(--header-bg);
      color: var(--header-text);
    }

    thead th {
      padding: 4px 6px;
      text-align: left;
      font-weight: 500;
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    thead th:last-child {
      border-right: none;
      text-align: center;
    }

    tbody tr:nth-child(odd) {
      background: #fefefe;
    }

    tbody tr:nth-child(even) {
      background: var(--row-alt);
    }

    tbody tr.row-ok {
      background: #dcfce7 !important;
    }

    tbody tr.row-error {
      background: #fee2e2 !important;
    }

    tbody tr.row-paused {
      background: #e5e7eb !important;
      color: #4b5563;
    }

    tbody td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .med-input {
      width: 100%;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(255, 255, 255, 0.96);
      font-size: 0.7rem;
      padding: 2px 4px;
    }

    .med-input[readonly] {
      background: #e5e7eb;
      color: #4b5563;
    }

    .dose-slot-input {
      width: 100%;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(255, 255, 255, 0.96);
      font-size: 0.7rem;
      padding: 2px 0;
      text-align: center;
    }

    .feedback {
      margin-top: 8px;
      font-size: 0.78rem;
      padding: 6px 8px;
      border-radius: 6px;
      display: none;
    }

    .feedback.ok {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .feedback.warn {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .footer {
      margin-top: 10px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .history-list {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.72rem;
    }

    .history-entry {
      padding: 4px 6px;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .history-entry:last-child {
      border-bottom: none;
    }

    .history-entry.history-ok {
      background: #f0fdf4;
      color: #166534;
    }

    .history-entry.history-error {
      background: #fef2f2;
      color: #b91c1c;
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.72rem;
      }

      thead {
        display: none;
      }

      table, tbody, tr, td {
        display: block;
        width: 100%;
      }

      tbody tr {
        margin-bottom: 8px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 6px;
      }

      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        margin-right: 6px;
        color: var(--text-muted);
        min-width: 90px;
      }

      .btn-icon {
        margin-left: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>L√§√§kelistan harjoittelu (Lifecare-tyyli)</h1>
    <div class="subtitle">
      Harjoitusymp√§rist√∂ ‚Äì ei oikeita potilastietoja. Tee l√§√§kelista l√§√§k√§rin tekstin mukaan ja etene p√§iv√§ kerrallaan.
    </div>

    <div class="card" id="task-card">
      <div class="card-header">
        <div class="card-title" id="task-title"></div>
        <div class="card-badge" id="task-badge"></div>
      </div>
      <div class="card-body" id="task-description"></div>
    </div>

    <div class="card">
      <div class="table-card-header">
        <div class="table-card-title">L√§√§kelista</div>
        <button class="btn btn-ghost" id="add-med-btn">
          Ôºã Lis√§√§ l√§√§kerivi
        </button>
      </div>

      <div class="table-wrapper">
        <table id="med-table">
          <thead>
            <tr>
              <th style="width: 8%;">Tyyppi</th>
              <th style="width: 11%;">Aikav√§li</th>
              <th style="width: 16%;">L√§√§ke</th>
              <th style="width: 7%;">Vahvuus</th>
              <th style="width: 7%;">Muoto</th>
              <th style="width: 7%;">Antoreitti</th>
              <th style="width: 8%;">Annostus</th>
              <th title="Y: 00.00‚Äì02.59">Y</th>
              <th title="AY: 03.00‚Äì05.59">AY</th>
              <th title="A: 06.00‚Äì08.59">A</th>
              <th title="AP: 09.00‚Äì11.59">AP</th>
              <th title="P: 12.00‚Äì14.59">P</th>
              <th title="IP: 15.00‚Äì17.59">IP</th>
              <th title="I: 18.00‚Äì20.59">I</th>
              <th title="IY: 21.00‚Äì23.59">IY</th>
              <th style="width: 5%;">Lopeta</th>
            </tr>
          </thead>
          <tbody id="med-tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        L√§√§kkeen nimen valinta t√§ytt√§√§ vahvuuden ja muodon automaattisesti, jos valmiste l√∂ytyy luettelosta.  
        Antoreitti (p.o., s.c., i.m., i.v.) valitaan k√§sin.  
        Y, AY, A, AP, P, IP, I, IY: merkitse tablettim√§√§r√§ (esim. 1, 0,5) tai <strong>injektioilla my√∂s vahvuus, esim. "40 mg"</strong>.  
        Tarvittaviin injektiol√§√§kkeisiin.
        Tyyppi <strong>Tauko</strong> harmaannuttaa rivin ja kertoo, ett√§ l√§√§ke on tauolla.
      </div>

      <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
        <button class="btn btn-primary" id="check-btn">
          ‚úÖ Tarkista
        </button>
        <button class="btn btn-ghost" id="next-btn" style="display:none;">
          Seuraava p√§iv√§ ‚ñ∂Ô∏é
        </button>
      </div>

      <div id="feedback" class="feedback"></div>
    </div>

    <div class="card">
      <div class="table-card-header">
        <div class="table-card-title">Historia (tarkistukset)</div>
      </div>
      <div id="history-list" class="history-list">
        Ei viel√§ tarkistuksia.
      </div>
    </div>
  </div>

  <datalist id="medications-list"></datalist>

  <script>
    function normDoseString(s) {
      return (s || "")
        .toLowerCase()
        .replace(",", ".")
        .replace(/\s*/g, "");
    }

    const MEDICATIONS = [
      { code: "PANADOL_1G_TAB",   name: "Panadol 1 g tabletti",               strength: "1 g",             form: "tabletti" },
      { code: "PANADOL_500_TAB",  name: "Panadol 500 mg tabletti",            strength: "500 mg",          form: "tabletti" },

      { code: "PANACOD_TAB",      name: "Panacod 500 mg/30 mg tabletti",      strength: "500 mg/30 mg",    form: "tabletti" },

      { code: "BURANA_400_TAB",   name: "Burana 400 mg tabletti",             strength: "400 mg",          form: "tabletti" },

      { code: "AMLODIPIN_5",      name: "Amlodipin 5 mg tabletti",            strength: "5 mg",            form: "tabletti" },
      { code: "OXCARB_300",       name: "Oxcarbazepin Orion 300 mg tabletti", strength: "300 mg",          form: "tabletti" },

      { code: "METFOREM_500",     name: "Metforem 500 mg tabletti",           strength: "500 mg",          form: "tabletti" },

      { code: "NOVORAPID_SC",     name: "NovoRapid 100 IU/ml inj s.c.",       strength: "100 IU/ml",       form: "injektio" },

      { code: "SERTRALIN_50",     name: "Sertralin Orion 50 mg tabletti",     strength: "50 mg",           form: "tabletti" },
      { code: "CIPRALEX_10",      name: "Cipralex 10 mg tabletti",            strength: "10 mg",           form: "tabletti" },

      { code: "SIMVA_20",         name: "Simvastatin Orion 20 mg tabl.",      strength: "20 mg",           form: "tabletti" },
      { code: "SIMVA_40",         name: "Simvastatin Orion 40 mg tabl.",      strength: "40 mg",           form: "tabletti" },

      { code: "PRIMASPAN_100",    name: "Primaspan 100 mg tabletti",          strength: "100 mg",          form: "tabletti" },
      { code: "ASPIRIN_100",      name: "Aspirin Cardio 100 mg tabletti",     strength: "100 mg",          form: "tabletti" },

      { code: "PRIMPERAN_IV",     name: "Primperan 10 mg/ml.",        strength: "10 mg/ml",        form: "injektio" },
      { code: "VOLTAREN_IM",      name: "Voltaren 75 mg.",            strength: "75 mg",           form: "injektio" },

      { code: "KLEXANE_40_SC",    name: "Klexane 40 mg/0,4 ml.",      strength: "40 mg/0,4 ml",    form: "injektio" },

      { code: "CEFUR_500_TAB",    name: "Cefuroxim 500 mg tabletti",          strength: "500 mg",          form: "tabletti" },
      { code: "CEFUR_500_IV",     name: "Cefuroxim 500 mg kuiva-aine.",          strength: "500 mg",          form: "injektio" },

      { code: "PLAVIX_75_TAB",    name: "Plavix 75 mg tabletti",              strength: "75 mg",           form: "tabletti" }
    ];

    const ASA_NAMES = [
      "primaspan 100 mg tabletti",
      "aspirin cardio 100 mg tabletti"
    ];

    const TASKS = [
      {
        title: "P√§iv√§ 1 ‚Äì Osastolle tulo, perusl√§√§kitys ja lopetukset",
        description: `72-vuotias potilas, jolla taustalla tyypin 2 diabetes, verenpainetauti ja paikallisalkuinen epilepsia. Osastolla verenpaine- ja verensokeriseuranta, laitetaan my√∂s telemetriaseuranta.

Siirtyy nyt vuodeosastolle. Osastol√§√§kityksen√§ jatketaan:
‚Äì Metforem 500 mg tabletti 1 x 2 p.o., Amlodipin 5 mg tabletti 1 x 1 p.o., Oxcarbazepin Orion 300 mg tabletti 1 x 2 p.o., Primaspan 100 mg tabletti 1 x 1 p.o., NovoRapid 100 IU/ml inj s.c. tarvittaessa aterian yhteydess√§, eo., Simvastatin Orion 20 mg tabl. nostetaan annokseen 40 mg iltaisin
Lopetetaan Plavix 75 mg tabletti ja Burana 400 mg tabletti.`
      },
      {
        title: "P√§iv√§ 2 ‚Äì Kipu, tromboosiprofylaksia ja parasetamoli",
        description: `Seuraavana p√§iv√§n√§ potilaalla on leikkauksen j√§lkeen kohtalaista haavakipua. Liikkuminen on v√§h√§ist√§ ja potilas tarvitsee runsaasti apua vuoteesta yl√∂s.

Lis√§t√§√§n tromboosiprofylaksia ja tarvittaessa kipul√§√§kitys:
Klexane 40 mg s.c. 1 x 1 iltaisin, 0,5g Parasetamoli p.o. tarvittaessa kipuun, 1 x 1‚Äì3
Kun Klexane aloitetaan, Primaspan 100 mg tabletti pidet√§√§n tauolla.

Muu s√§√§nn√∂llinen l√§√§kitys jatkuu ennallaan.`
      },
      {
        title: "P√§iv√§ 3 ‚Äì Pahoinvointi ja lis√§kipu",
        description: `Kolmantena osastop√§iv√§n√§ potilaalla esiintyy ajoittain pahoinvointia ja hetkellisesti voimakkaampaa kipua liikkeellel√§hd√∂n yhteydess√§.

Lis√§t√§√§n tarvittaessa annettavat injektiol√§√§kkeet:

‚Äì Primperan 10 mg i.v. tarvittaessa pahoinvointiin, 1 x 1‚Äì3, Voltaren 75 mg i.m. tarvittaessa kipuun, 1 x 1‚Äì2

Perusl√§√§kitys, Klexane ja tarvittaessa parasetamoli sek√§ NovoRapid jatkuvat ennallaan. Primaspan on edelleen tauolla Klexanen ajan (tyyppi Tauko).`
      },
      {
        title: "P√§iv√§ 4 ‚Äì Klexane lopetetaan, Primaspan takaisin",
        description: `Potilas on kuntoutunut, k√§velee osastolla ja siirtyy vuoteesta tuoliin itsen√§isesti. Laskimotukosriski arvioidaan pienentyneeksi.

Klexane 40 mg s.c. 1 x 1 iltaisin lopetetaan.
Primaspan 100 mg tabletti 1 x 1 p.o. aloitetaan uudelleen tauon j√§lkeen.

Muu l√§√§kitys jatkuu ennallaan.`
      },
      {
        title: "P√§iv√§ 5 ‚Äì Antibioottihoito (cefuroxim-kuuri)",
        description: `T√§n√§√§n on 12.12.2025. Potilaalle on kehittynyt hengitystieinfektioon sopiva kliininen kuva, CRP ja tulehdusarvot koholla.

Aloitetaan m√§√§r√§aikainen antibioottihoito:

Cefuroxim 500 mg tabletti p.o. 1 x 2, 7 vuorokauden kuuri t√§st√§ aamusta l√§htien.

Kuurin kesto: 7 vrk 12.12.2025 eteenp√§in.

Klexane on lopetettu, Primaspan on j√§lleen k√§yt√∂ss√§, ja muu aiempi l√§√§kitys jatkuu, ellei erikseen ole p√§√§tetty lopettaa.`
      }
    ];

    const INITIAL_LIST = [
      {
        medCode: "METFOREM_500",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Metforem 500 mg tabletti",
        strength: "500 mg",
        form: "tabletti",
        dose: "1 x 2",
        y: "", ay: "", a: "1", ap: "", p: "", ip: "", i: "1", iy: ""
      },
      {
        medCode: "AMLODIPIN_5",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Amlodipin 5 mg tabletti",
        strength: "5 mg",
        form: "tabletti",
        dose: "1 x 1",
        y: "", ay: "", a: "1", ap: "", p: "", ip: "", i: "", iy: ""
      },
      {
        medCode: "OXCARB_300",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Oxcarbazepin Orion 300 mg tabletti",
        strength: "300 mg",
        form: "tabletti",
        dose: "1 x 2",
        y: "", ay: "", a: "1", ap: "", p: "", ip: "", i: "1", iy: ""
      },
      {
        medCode: "PRIMASPAN_100",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Primaspan 100 mg tabletti",
        strength: "100 mg",
        form: "tabletti",
        dose: "1 x 1",
        y: "", ay: "", a: "1", ap: "", p: "", ip: "", i: "", iy: ""
      },
      {
        medCode: "NOVORAPID_SC",
        type: "Tarvittava",
        period: "",
        route: "s.c.",
        drugName: "NovoRapid 100 IU/ml inj s.c.",
        strength: "100 IU/ml",
        form: "injektio",
        dose: "eo.",
        y: "", ay: "", a: "", ap: "", p: "", ip: "", i: "", iy: ""
      },
      {
        medCode: "SIMVA_20",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Simvastatin Orion 20 mg tabl.",
        strength: "20 mg",
        form: "tabletti",
        dose: "1 x 1",
        y: "", ay: "", a: "", ap: "", p: "", ip: "", i: "1", iy: ""
      },
      {
        medCode: "PLAVIX_75_TAB",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Plavix 75 mg tabletti",
        strength: "75 mg",
        form: "tabletti",
        dose: "1 x 1",
        y: "", ay: "", a: "", ap: "", p: "1", ip: "", i: "", iy: ""
      },
      {
        medCode: "BURANA_400_TAB",
        type: "Jatkuva",
        period: "",
        route: "p.o.",
        drugName: "Burana 400 mg tabletti",
        strength: "400 mg",
        form: "tabletti",
        dose: "1 x 3",
        y: "", ay: "", a: "1", ap: "", p: "1", ip: "", i: "1", iy: ""
      }
    ];

    const targetMetforem = {
      drugName: "metforem 500 mg tabletti",
      strength: "500 mg",
      form: "tabletti",
      dose: normDoseString("1 x 2"),
      a: "1",
      i: "1",
      type: "Jatkuva",
      route: "p.o."
    };

    const targetAmlodipin = {
      drugName: "amlodipin 5 mg tabletti",
      strength: "5 mg",
      form: "tabletti",
      dose: normDoseString("1 x 1"),
      type: "Jatkuva",
      route: "p.o."
    };

    const targetOxcarb = {
      drugName: "oxcarbazepin orion 300 mg tabletti",
      strength: "300 mg",
      form: "tabletti",
      dose: normDoseString("1 x 2"),
      type: "Jatkuva",
      route: "p.o."
    };

    const targetASA = {
      strength: "100 mg",
      form: "tabletti",
      dose: normDoseString("1 x 1"),
      type: "Jatkuva",
      route: "p.o."
    };

    const targetCefuroxim = {
      drugName: "cefuroxim 500 mg tabletti",
      strength: "500 mg",
      form: "tabletti",
      type: "M√§√§r√§aikainen",
      route: "p.o.",
      periodNorm: "12.12.2025-18.12.2025"
    };

    let meds = JSON.parse(JSON.stringify(INITIAL_LIST));
    let currentTaskIndex = 0;
    let lastCheckOK = false;
    let feedbackHistory = [];

    const taskTitleEl = document.getElementById("task-title");
    const taskBadgeEl = document.getElementById("task-badge");
    const taskDescriptionEl = document.getElementById("task-description");

    const tbody = document.getElementById("med-tbody");
    const addMedBtn = document.getElementById("add-med-btn");
    const checkBtn = document.getElementById("check-btn");
    const nextBtn = document.getElementById("next-btn");
    const feedbackEl = document.getElementById("feedback");
    const datalistEl = document.getElementById("medications-list");
    const historyListEl = document.getElementById("history-list");

    MEDICATIONS.forEach(med => {
      const opt = document.createElement("option");
      opt.value = med.name;
      datalistEl.appendChild(opt);
    });

    function renderTask() {
      const t = TASKS[currentTaskIndex];
      taskTitleEl.textContent = t.title;
      taskDescriptionEl.textContent = t.description;
      taskBadgeEl.textContent = `P√§iv√§ ${currentTaskIndex + 1} / ${TASKS.length}`;
    }

    function findMedicationByName(name) {
      const trimmed = (name || "").trim().toLowerCase();
      return MEDICATIONS.find(m => m.name.toLowerCase() === trimmed) || null;
    }

    function ensureScheduleFields(med) {
      const keys = ["y", "ay", "a", "ap", "p", "ip", "i", "iy"];
      keys.forEach(k => {
        if (typeof med[k] === "undefined") med[k] = "";
      });
      if (typeof med.type === "undefined") med.type = "Jatkuva";
      if (typeof med.period === "undefined") med.period = "";
      if (typeof med.route === "undefined") med.route = "";
      return med;
    }

    function renderMedTable() {
      tbody.innerHTML = "";
      meds.forEach((med, index) => {
        ensureScheduleFields(med);
        const tr = document.createElement("tr");
        tr.dataset.index = index;

        if (med.type === "Tauko") {
          tr.classList.add("row-paused");
        }

        const createInputCell = (label, value, onInput, options = {}) => {
          const td = document.createElement("td");
          td.setAttribute("data-label", label);
          const input = document.createElement("input");
          input.className = "med-input";
          input.value = value || "";
          if (options.readonly) input.readOnly = true;
          if (options.datalist) input.setAttribute("list", options.datalist);
          if (options.disabled) input.disabled = true;
          input.addEventListener("input", (e) => {
            if (!input.readOnly && !input.disabled) {
              onInput(e.target.value);
            }
          });
          if (options.onBlur) {
            input.addEventListener("blur", (e) => options.onBlur(e.target.value));
          }
          td.appendChild(input);
          return td;
        };

        const createDoseCell = (label, key) => {
          const td = document.createElement("td");
          td.setAttribute("data-label", label);
          const input = document.createElement("input");
          input.className = "dose-slot-input";
          input.value = med[key] || "";
          input.addEventListener("input", (e) => {
            meds[index][key] = e.target.value;
          });
          td.appendChild(input);
          return td;
        };

        const tdType = document.createElement("td");
        tdType.setAttribute("data-label", "Tyyppi");
        const selType = document.createElement("select");
        selType.className = "med-input";
        ["Jatkuva", "Tarvittava", "M√§√§r√§aikainen", "Tauko"].forEach(optVal => {
          const o = document.createElement("option");
          o.value = optVal;
          o.textContent = optVal;
          if (med.type === optVal) o.selected = true;
          selType.appendChild(o);
        });
        selType.addEventListener("change", e => {
          meds[index].type = e.target.value;
          renderMedTable();
        });
        tdType.appendChild(selType);
        tr.appendChild(tdType);

        // Aikav√§li: M√§√§r√§aikainen + Cefuroxim k√§ytt√§√§ "Joulukuu 2025" -valintaa ilman oletusp√§iv√§m√§√§ri√§
        if (med.type === "M√§√§r√§aikainen") {
          const nameLower = (med.drugName || "").trim().toLowerCase();
          if (nameLower === targetCefuroxim.drugName) {
            const td = document.createElement("td");
            td.setAttribute("data-label", "Aikav√§li");

            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.gap = "2px";

            const label = document.createElement("div");
            label.style.fontSize = "0.65rem";
            label.style.color = "#6b7280";
            label.textContent = "Joulukuu 2025";

            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.gap = "4px";
            row.style.alignItems = "center";

            let startDay = null;
            let endDay = null;
            if (med.period) {
              const norm = med.period.replace(/\s/g, "").replace("‚Äì", "-");
              const m = norm.match(/(\d{1,2})\.12\.2025-(\d{1,2})\.12\.2025/);
              if (m) {
                startDay = parseInt(m[1], 10);
                endDay = parseInt(m[2], 10);
              }
            }

            const startSel = document.createElement("select");
            startSel.className = "med-input";
            startSel.style.padding = "1px 4px";

            const endSel = document.createElement("select");
            endSel.className = "med-input";
            endSel.style.padding = "1px 4px";

            const startPlaceholder = document.createElement("option");
            startPlaceholder.value = "";
            startPlaceholder.textContent = "-";
            if (startDay === null) startPlaceholder.selected = true;
            startSel.appendChild(startPlaceholder);

            const endPlaceholder = document.createElement("option");
            endPlaceholder.value = "";
            endPlaceholder.textContent = "-";
            if (endDay === null) endPlaceholder.selected = true;
            endSel.appendChild(endPlaceholder);

            for (let d = 1; d <= 31; d++) {
              const o1 = document.createElement("option");
              o1.value = d;
              o1.textContent = d;
              if (startDay === d) o1.selected = true;
              startSel.appendChild(o1);

              const o2 = document.createElement("option");
              o2.value = d;
              o2.textContent = d;
              if (endDay === d) o2.selected = true;
              endSel.appendChild(o2);
            }

            function updatePeriod() {
              const sVal = startSel.value;
              const eVal = endSel.value;
              if (!sVal || !eVal) {
                meds[index].period = "";
                return;
              }
              const s = parseInt(sVal, 10);
              const e = parseInt(eVal, 10);
              meds[index].period = `${s}.12.2025‚Äì${e}.12.2025`;
            }

            startSel.addEventListener("change", updatePeriod);
            endSel.addEventListener("change", updatePeriod);

            const arrowSpan = document.createElement("span");
            arrowSpan.textContent = "‚Üí";
            arrowSpan.style.fontSize = "0.7rem";

            row.appendChild(startSel);
            row.appendChild(arrowSpan);
            row.appendChild(endSel);

            wrapper.appendChild(label);
            wrapper.appendChild(row);
            td.appendChild(wrapper);
            tr.appendChild(td);
          } else {
            tr.appendChild(
              createInputCell(
                "Aikav√§li",
                med.period || "",
                (val) => { meds[index].period = val; }
              )
            );
          }
        } else {
          tr.appendChild(
            createInputCell(
              "Aikav√§li",
              med.period || "",
              () => {},
              { readonly: true, disabled: true }
            )
          );
        }

        const drugCell = createInputCell(
          "L√§√§ke",
          med.drugName || "",
          (val) => { meds[index].drugName = val; },
          {
            datalist: "medications-list",
            onBlur: (val) => {
              const match = findMedicationByName(val);
              if (match) {
                meds[index].medCode = match.code;
                meds[index].drugName = match.name;
                meds[index].strength = match.strength;
                meds[index].form = match.form;
                renderMedTable();
              } else {
                meds[index].medCode = null;
              }
            }
          }
        );
        tr.appendChild(drugCell);

        const isKnown = !!med.medCode;

        tr.appendChild(
          createInputCell(
            "Vahvuus",
            med.strength || "",
            (val) => { if (!isKnown) meds[index].strength = val; },
            { readonly: isKnown }
          )
        );

        tr.appendChild(
          createInputCell(
            "Muoto",
            med.form || "",
            (val) => { if (!isKnown) meds[index].form = val; },
            { readonly: isKnown }
          )
        );

        const tdRoute = document.createElement("td");
        tdRoute.setAttribute("data-label", "Antoreitti");
        const selRoute = document.createElement("select");
        selRoute.className = "med-input";
        ["", "p.o.", "s.c.", "i.m.", "i.v.", "muu"].forEach(optVal => {
          const o = document.createElement("option");
          o.value = optVal;
          o.textContent = optVal || "-";
          if (med.route === optVal) o.selected = true;
          selRoute.appendChild(o);
        });
        selRoute.addEventListener("change", e => {
          meds[index].route = e.target.value;
        });
        tdRoute.appendChild(selRoute);
        tr.appendChild(tdRoute);

        tr.appendChild(
          createInputCell(
            "Annostus",
            med.dose || "",
            (val) => { meds[index].dose = val; }
          )
        );

        tr.appendChild(createDoseCell("Y", "y"));
        tr.appendChild(createDoseCell("AY", "ay"));
        tr.appendChild(createDoseCell("A", "a"));
        tr.appendChild(createDoseCell("AP", "ap"));
        tr.appendChild(createDoseCell("P", "p"));
        tr.appendChild(createDoseCell("IP", "ip"));
        tr.appendChild(createDoseCell("I", "i"));
        tr.appendChild(createDoseCell("IY", "iy"));

        const tdDelete = document.createElement("td");
        tdDelete.setAttribute("data-label", "Lopeta");
        tdDelete.style.textAlign = "center";
        const delBtn = document.createElement("button");
        delBtn.className = "btn-icon";
        delBtn.innerHTML = "üóë";
        delBtn.title = "Lopeta / poista rivi";
        delBtn.addEventListener("click", () => {
          meds.splice(index, 1);
          renderMedTable();
        });
        tdDelete.appendChild(delBtn);
        tr.appendChild(tdDelete);

        tbody.appendChild(tr);
      });
    }

    function renderAll() {
      renderMedTable();
      updateNextButtonVisibility();
    }

    function normalizeRow(m) {
      const normNum = (v) => (v || "").trim().replace(",", ".");
      return {
        drugName: (m.drugName || "").trim().toLowerCase(),
        strength: (m.strength || "").trim().toLowerCase(),
        form: (m.form || "").trim().toLowerCase(),
        route: (m.route || "").trim().toLowerCase(),
        dose: normDoseString(m.dose),
        y: normNum(m.y),
        ay: normNum(m.ay),
        a: normNum(m.a),
        ap: normNum(m.ap),
        p: normNum(m.p),
        ip: normNum(m.ip),
        i: normNum(m.i),
        iy: normNum(m.iy),
        type: (m.type || "").trim(),
        period: (m.period || "").trim()
      };
    }

    function renderHistory() {
      if (feedbackHistory.length === 0) {
        historyListEl.textContent = "Ei viel√§ tarkistuksia.";
        return;
      }
      historyListEl.innerHTML = "";
      feedbackHistory.forEach(entry => {
        const div = document.createElement("div");
        div.className = "history-entry " + (entry.ok ? "history-ok" : "history-error");
        div.textContent = `${entry.time} ‚Äì P√§iv√§ ${entry.day}: ${entry.message}`;
        historyListEl.appendChild(div);
      });
    }

    function addToHistory(message, ok) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString("fi-FI", { hour: "2-digit", minute: "2-digit" });
      feedbackHistory.unshift({
        day: currentTaskIndex + 1,
        ok,
        message,
        time: timeStr
      });
      if (feedbackHistory.length > 30) {
        feedbackHistory.pop();
      }
      renderHistory();
    }

    function showFeedback(message, ok) {
      feedbackEl.textContent = message;
      feedbackEl.classList.remove("ok", "warn");
      feedbackEl.classList.add(ok ? "ok" : "warn");
      feedbackEl.style.display = "block";
      addToHistory(message, ok);
    }

    function updateNextButtonVisibility() {
      if (lastCheckOK && currentTaskIndex < TASKS.length - 1) {
        nextBtn.style.display = "inline-flex";
      } else {
        nextBtn.style.display = "none";
      }
    }

    function scheduleIsEmpty(row) {
      return !row.y && !row.ay && !row.a && !row.ap && !row.p && !row.ip && !row.i && !row.iy;
    }

    function checkBaseMeds(rows) {
      const met = rows.find(r => r.drugName === targetMetforem.drugName);
      if (!met) {
        showFeedback("Metforem 500 mg tabletti puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        met.strength !== targetMetforem.strength.toLowerCase() ||
        met.form !== targetMetforem.form.toLowerCase() ||
        met.dose !== targetMetforem.dose ||
        met.a !== targetMetforem.a ||
        met.i !== targetMetforem.i ||
        met.type !== targetMetforem.type ||
        met.route !== targetMetforem.route
      ) {
        showFeedback("Metforem ei ole oikein. Tyyppi Jatkuva, antoreitti p.o., annos 1 x 2 ja 1 A + 1 I.", false);
        return false;
      }

      const aml = rows.find(r => r.drugName === targetAmlodipin.drugName);
      if (!aml) {
        showFeedback("Amlodipin 5 mg tabletti puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        aml.strength !== targetAmlodipin.strength.toLowerCase() ||
        aml.form !== targetAmlodipin.form.toLowerCase() ||
        aml.dose !== targetAmlodipin.dose ||
        aml.type !== targetAmlodipin.type ||
        aml.route !== targetAmlodipin.route
      ) {
        showFeedback("Amlodipin ei ole oikein. Tyyppi Jatkuva, antoreitti p.o., annos 1 x 1.", false);
        return false;
      }

      const ox = rows.find(r => r.drugName === targetOxcarb.drugName);
      if (!ox) {
        showFeedback("Oxcarbazepin Orion 300 mg tabletti puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        ox.strength !== targetOxcarb.strength.toLowerCase() ||
        ox.form !== targetOxcarb.form.toLowerCase() ||
        ox.dose !== targetOxcarb.dose ||
        ox.type !== targetOxcarb.type ||
        ox.route !== targetOxcarb.route
      ) {
        showFeedback("Oxcarbazepin ei ole oikein. Tyyppi Jatkuva, antoreitti p.o., annos 1 x 2.", false);
        return false;
      }

      return true;
    }

    function checkASAActive(rows) {
      const asaRows = rows.filter(r => ASA_NAMES.includes(r.drugName));
      if (asaRows.length === 0) {
        showFeedback("ASA-profylaksia (Primaspan 100 mg tai Aspirin Cardio 100 mg) puuttuu, vaikka sen pit√§isi olla k√§yt√∂ss√§.", false);
        return false;
      }
      const active = asaRows.find(r =>
        r.type === "Jatkuva" &&
        r.route === targetASA.route &&
        r.strength === targetASA.strength.toLowerCase() &&
        r.form === targetASA.form.toLowerCase() &&
        r.dose === targetASA.dose
      );
      if (!active) {
        showFeedback("ASA-profylaksia ei ole oikein. Tyyppi Jatkuva, antoreitti p.o., annos 1 x 1.", false);
        return false;
      }
      return true;
    }

    function checkASASuspended(rows) {
      const asaRows = rows.filter(r => ASA_NAMES.includes(r.drugName));
      const active = asaRows.find(r => r.type === "Jatkuva");
      if (active) {
        showFeedback("Primaspan/Aspirin tulee olla tauolla Klexanen aikana (tyyppi Tauko tai ei rivi√§ lainkaan).", false);
        return false;
      }
      return true;
    }

    function checkStatinUp(rows) {
      const simva20rows = rows.filter(r => r.drugName === "simvastatin orion 20 mg tabl.");
      const simva40rows = rows.filter(r => r.drugName === "simvastatin orion 40 mg tabl.");

      const hasOld20 = simva20rows.some(r => r.dose === normDoseString("1 x 1"));

      const ok20evening = simva20rows.some(r => {
        const dose20evening = (r.dose === normDoseString("2 x 1") && r.i === "2");
        const dose20split = (r.dose === normDoseString("1 x 2") && r.a === "1" && r.i === "1");
        return (dose20evening || dose20split) &&
               r.type === "Jatkuva" &&
               r.route === "p.o.";
      });

      const ok40 = simva40rows.some(r =>
        r.dose === normDoseString("1 x 1") &&
        r.i === "1" &&
        r.type === "Jatkuva" &&
        r.route === "p.o."
      );

      if (!ok20evening && !ok40) {
        showFeedback("Simvastatiini ei ole oikein. Hyv√§ksyt√§√§n joko 20 mg 2 x 1 (I=2) / 1 x 2 (A=1, I=1) TAI 40 mg 1 x 1 (I=1).", false);
        return false;
      }
      if (hasOld20) {
        showFeedback("Simvastatin Orion 20 mg 1 x 1 ei saa olla en√§√§ listalla (annos nostettu).", false);
        return false;
      }
      return true;
    }

    function checkNoPlavixBurana(rows) {
      const plavix = rows.find(r => r.drugName === "plavix 75 mg tabletti");
      const burana = rows.find(r => r.drugName === "burana 400 mg tabletti");
      if (plavix || burana) {
        showFeedback("Plavix 75 mg ja Burana 400 mg on m√§√§r√§tty lopetettaviksi ‚Äì niiden ei tule en√§√§ olla l√§√§kelistalla.", false);
        return false;
      }
      return true;
    }

    function checkTask1(rows) {
      if (!checkBaseMeds(rows)) return false;
      if (!checkASAActive(rows)) return false;
      if (!checkStatinUp(rows)) return false;
      if (!checkNoPlavixBurana(rows)) return false;
      showFeedback("P√§iv√§n 1 tilanne merkitty oikein: perusl√§√§kitys, ASA, simvastatiinin annosmuutos ja Plavixin sek√§ Buranan lopetus.", true);
      return true;
    }

function checkPanadol(rows) {
  const pans = rows.filter(r =>
    r.drugName.startsWith("panadol") && r.form === "tabletti"
  );

  if (pans.length === 0) {
    showFeedback("Panadol/parasetamoli ei l√∂ydy l√§√§kelistalta.", false);
    return false;
  }

  const ok = pans.some(p => {
    if (p.type !== "Tarvittava" || p.route !== "p.o." || !scheduleIsEmpty(p)) {
      return false;
    }

    const doseNorm = normDoseString(p.dose);

    const variant500 =
      p.strength === "500 mg" &&
      doseNorm === normDoseString("1 x 1-3");

    const variant1gHalf =
      p.strength === "1 g" &&
      doseNorm === normDoseString("0.5 x 1-3"); // "0,5 x 1‚Äì3" toimii my√∂s, normDoseString muuttaa pilkun pisteeksi

    return variant500 || variant1gHalf;
  });

  if (!ok) {
    showFeedback(
      "Parasetamoli ei ole oikein. Hyv√§ksyt√§√§n:\n" +
      "‚Ä¢ Panadol 500 mg tabletti, annos 1 x 1‚Äì3 TAI\n" +
      "‚Ä¢ Panadol 1 g tabletti, annos 0,5 x 1‚Äì3\n" +
      "‚Ä¢ Tyyppi Tarvittava, antoreitti p.o.\n" +
      "‚Ä¢ Y‚ÄìIY-aikaruutujen tulee olla tyhj√§t.",
      false
    );
    return false;
  }


      return true;
    }

    function checkIVandIM(rows) {
      const prim = rows.find(r =>
        r.drugName === "primperan 10 mg/ml." &&
        r.strength === "10 mg/ml" &&
        r.form === "injektio"
      );
      if (!prim) {
        showFeedback("Primperan 10 mg/ml inj i.v. puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        prim.dose !== normDoseString("1 x 1-3") ||
        prim.type !== "Tarvittava" ||
        prim.route !== "i.v."
      ) {
        showFeedback("Primperan ei ole oikein. Tyyppi Tarvittava, antoreitti i.v., annos 1 x 1‚Äì3. Y‚ÄìIY tyhj√§t.", false);
        return false;
      }
      if (!scheduleIsEmpty(prim)) {
        showFeedback("Primperan on tarvittava injektio ‚Äì j√§t√§ Y‚ÄìIY-aikaruudut tyhjiksi.", false);
        return false;
      }

      const volt = rows.find(r =>
        r.drugName === "voltaren 75 mg." &&
        r.strength === "75 mg" &&
        r.form === "injektio"
      );
      if (!volt) {
        showFeedback("Voltaren 75 mg inj i.m. puuttuu l√§√§kelistalta.", false);
        return false;
      }
      if (
        volt.dose !== normDoseString("1 x 1-2") ||
        volt.type !== "Tarvittava" ||
        volt.route !== "i.m."
      ) {
        showFeedback("Voltaren ei ole oikein. Tyyppi Tarvittava, antoreitti i.m., annos 1 x 1‚Äì2. Y‚ÄìIY tyhj√§t.", false);
        return false;
      }
      if (!scheduleIsEmpty(volt)) {
        showFeedback("Voltaren on tarvittava injektio ‚Äì j√§t√§ Y‚ÄìIY-aikaruudut tyhjiksi.", false);
        return false;
      }

      return true;
    }

    function checkKlexanePresent(rows) {
      const klex = rows.find(r =>
        r.drugName === "klexane 40 mg/0,4 ml." &&
        r.strength === "40 mg/0,4 ml" &&
        r.form === "injektio"
      );
      if (!klex) {
        showFeedback("Klexane 40 mg/0,4 ml inj s.c. puuttuu l√§√§kelistalta, vaikka se on m√§√§r√§tty.", false);
        return false;
      }

      if (klex.type !== "Jatkuva" || klex.route !== "s.c.") {
        showFeedback("Klexanen tulee olla tyypilt√§√§n Jatkuva ja antoreitti s.c.", false);
        return false;
      }

      const iVal = (klex.i || "").trim().toLowerCase();
      const okI = (iVal === "1" || /mg|g/.test(iVal));
      if (!okI) {
        showFeedback("Klexanen I-sarakkeessa tulee olla joko \"1\" TAI vahvuus, jossa on mg- tai g-yksikk√∂ (esim. \"40 mg\").", false);
        return false;
      }

      return true;
    }

    function checkNoKlexane(rows) {
      const klex = rows.find(r =>
        r.drugName === "klexane 40 mg/0,4 ml."
      );
      if (klex) {
        showFeedback("Klexane on m√§√§r√§tty lopetettavaksi ‚Äì sen ei tule en√§√§ olla l√§√§kelistalla.", false);
        return false;
      }
      return true;
    }

      function checkCefuroxim(rows) {
      // Etsi normalized-rivist√§ cefuroxim- tablettil√§√§ke
      const cefRow = rows.find(r =>
        r.drugName === targetCefuroxim.drugName &&
        r.strength === targetCefuroxim.strength.toLowerCase() &&
        r.form === targetCefuroxim.form.toLowerCase()
      );

      if (!cefRow) {
        showFeedback("Cefuroxim 500 mg tabletti puuttuu l√§√§kelistalta.", false);
        return false;
      }

      if (cefRow.type !== targetCefuroxim.type || cefRow.route !== targetCefuroxim.route) {
        showFeedback("Cefuroxim tulee merkit√§ tyypiksi M√§√§r√§aikainen ja antoreitiksi p.o. (ei i.v.).", false);
        return false;
      }

      // Haetaan vastaava 'med'-olio, josta l√∂ytyy startDay / endDay
      const cefMed = meds.find(m =>
        (m.drugName || "").trim().toLowerCase() === targetCefuroxim.drugName
      );

      if (!cefMed) {
        showFeedback("Cefuroxim-rivi√§ ei l√∂ytynyt sis√§isest√§ listasta (tekninen virhe).", false);
        return false;
      }

      let startDay = typeof cefMed.startDay === "number" ? cefMed.startDay : null;
      let endDay   = typeof cefMed.endDay   === "number" ? cefMed.endDay   : null;

      // Varmuuden vuoksi yritet√§√§n viel√§ parsia periodista, jos start/end puuttuvat
      if ((startDay === null || endDay === null) && cefMed.period) {
        const norm = cefMed.period.replace(/\s/g, "").replace("‚Äì", "-");
        const m = norm.match(/(\d{1,2})\.12\.2025-(\d{1,2})\.12\.2025/);
        if (m) {
          startDay = parseInt(m[1], 10);
          endDay   = parseInt(m[2], 10);
        }
      }

      if (startDay === null || endDay === null) {
        showFeedback("Valitse Cefuroxim-kuurille sek√§ alkup√§iv√§ ett√§ loppup√§iv√§ Joulukuu 2025 -valikosta.", false);
        return false;
      }

      if (startDay !== 12 || endDay !== 18) {
        showFeedback("Cefuroxim-kuurin aikav√§lin tulee olla 12.12.2025‚Äì18.12.2025 (12 ‚Üí 18).", false);
        return false;
      }

      return true;
    }


    function evaluateRow(row) {
      if (row.drugName === "plavix 75 mg tabletti" || row.drugName === "burana 400 mg tabletti") {
        return "error";
      }

      if (row.drugName === targetMetforem.drugName) {
        if (
          row.strength === targetMetforem.strength.toLowerCase() &&
          row.form === targetMetforem.form.toLowerCase() &&
          row.dose === targetMetforem.dose &&
          row.a === targetMetforem.a &&
          row.i === targetMetforem.i &&
          row.type === targetMetforem.type &&
          row.route === targetMetforem.route
        ) return "ok";
        return "error";
      }

      if (row.drugName === targetAmlodipin.drugName) {
        if (
          row.strength === targetAmlodipin.strength.toLowerCase() &&
          row.form === targetAmlodipin.form.toLowerCase() &&
          row.dose === targetAmlodipin.dose &&
          row.type === targetAmlodipin.type &&
          row.route === targetAmlodipin.route
        ) return "ok";
        return "error";
      }

      if (row.drugName === targetOxcarb.drugName) {
        if (
          row.strength === targetOxcarb.strength.toLowerCase() &&
          row.form === targetOxcarb.form.toLowerCase() &&
          row.dose === targetOxcarb.dose &&
          row.type === targetOxcarb.type &&
          row.route === targetOxcarb.route
        ) return "ok";
        return "error";
      }

      if (ASA_NAMES.includes(row.drugName)) {
        const asaBaseOk =
          row.strength === targetASA.strength.toLowerCase() &&
          row.form === targetASA.form.toLowerCase() &&
          row.dose === targetASA.dose &&
          row.route === targetASA.route;
        if (currentTaskIndex === 0 || currentTaskIndex === 3 || currentTaskIndex === 4) {
          if (asaBaseOk && row.type === "Jatkuva") return "ok";
          return "error";
        } else {
          if (asaBaseOk && row.type === "Tauko") return "ok";
          return "error";
        }
      }

      if (row.drugName === "simvastatin orion 20 mg tabl." ||
          row.drugName === "simvastatin orion 40 mg tabl.") {

        const dose20evening = (
          row.drugName === "simvastatin orion 20 mg tabl." &&
          row.dose === normDoseString("2 x 1") &&
          row.i === "2" &&
          row.type === "Jatkuva" &&
          row.route === "p.o."
        );

        const dose20split = (
          row.drugName === "simvastatin orion 20 mg tabl." &&
          row.dose === normDoseString("1 x 2") &&
          row.a === "1" &&
          row.i === "1" &&
          row.type === "Jatkuva" &&
          row.route === "p.o."
        );

        const dose40 = (
          row.drugName === "simvastatin orion 40 mg tabl." &&
          row.dose === normDoseString("1 x 1") &&
          row.i === "1" &&
          row.type === "Jatkuva" &&
          row.route === "p.o."
        );

        const old20 = (
          row.drugName === "simvastatin orion 20 mg tabl." &&
          row.dose === normDoseString("1 x 1")
        );

        if (old20) return "error";
        if (dose20evening || dose20split || dose40) return "ok";
        return "error";
      }

      if (row.drugName.startsWith("panadol") && row.form === "tabletti") {
        const ok = (
          (row.strength === "1 g" || row.strength === "500 mg") &&
          row.dose === normDoseString("1 x 1-3") &&
          row.type === "Tarvittava" &&
          row.route === "p.o." &&
          scheduleIsEmpty(row)
        );
        return ok ? "ok" : "error";
      }

      if (row.drugName === "primperan 10 mg/ml.") {
        const ok = (
          row.strength === "10 mg/ml" &&
          row.form === "injektio" &&
          row.dose === normDoseString("1 x 1-3") &&
          row.type === "Tarvittava" &&
          row.route === "i.v." &&
          scheduleIsEmpty(row)
        );
        return ok ? "ok" : "error";
      }

      if (row.drugName === "voltaren 75 mg.") {
        const ok = (
          row.strength === "75 mg" &&
          row.form === "injektio" &&
          row.dose === normDoseString("1 x 1-2") &&
          row.type === "Tarvittava" &&
          row.route === "i.m." &&
          scheduleIsEmpty(row)
        );
        return ok ? "ok" : "error";
      }

      if (row.drugName === "klexane 40 mg/0,4 ml.") {
        const iVal = (row.i || "").trim().toLowerCase();
        const okI = (iVal === "1" || /mg|g/.test(iVal));
        if (currentTaskIndex === 1 || currentTaskIndex === 2) {
          if (row.type === "Jatkuva" && row.route === "s.c." && okI) return "ok";
          return "error";
        } else {
          return "error";
        }
      }

      if (row.drugName === targetCefuroxim.drugName) {
        const normPeriod = row.period.replace(/\s/g, "").replace("‚Äì", "-");
        const ok = (
          row.strength === targetCefuroxim.strength.toLowerCase() &&
          row.form === targetCefuroxim.form.toLowerCase() &&
          row.type === targetCefuroxim.type &&
          row.route === targetCefuroxim.route &&
          normPeriod === targetCefuroxim.periodNorm
        );
        return ok ? "ok" : "error";
      }

      return "neutral";
    }

    function colorRows(rows) {
      Array.from(tbody.children).forEach(tr => {
        tr.classList.remove("row-ok", "row-error");
        if (tr.classList.contains("row-paused")) {
          return;
        }
        const idx = parseInt(tr.dataset.index, 10);
        const row = rows[idx];
        if (!row) return;
        const status = evaluateRow(row);
        if (status === "ok") tr.classList.add("row-ok");
        if (status === "error") tr.classList.add("row-error");
      });
    }

    function checkCurrentTask() {
      const rows = meds
        .map(m => ensureScheduleFields(m))
        .map(m => normalizeRow(m))
        .filter(r => r.drugName || r.strength || r.dose);

      if (rows.length === 0) {
        showFeedback("L√§√§kelista on tyhj√§. Lis√§√§ l√§√§kkeet l√§√§k√§rin tekstin mukaisesti.", false);
        colorRows(rows);
        return false;
      }

      let ok = false;

      switch (currentTaskIndex) {
        case 0: {
          ok = checkTask1(rows);
          break;
        }
        case 1: {
          if (!checkBaseMeds(rows)) break;
          if (!checkStatinUp(rows)) break;
          if (!checkNoPlavixBurana(rows)) break;
          if (!checkPanadol(rows)) break;
          if (!checkKlexanePresent(rows)) break;
          if (!checkASASuspended(rows)) break;
          showFeedback("P√§iv√§n 2 l√§√§kitys on oikein: perusl√§√§kitys, simvastatiinin annosmuutos, Klexane ja tarvittava parasetamoli ‚Äì Primaspan tauolla.", true);
          ok = true;
          break;
        }
        case 2: {
          if (!checkBaseMeds(rows)) break;
          if (!checkStatinUp(rows)) break;
          if (!checkNoPlavixBurana(rows)) break;
          if (!checkPanadol(rows)) break;
          if (!checkKlexanePresent(rows)) break;
          if (!checkIVandIM(rows)) break;
          if (!checkASASuspended(rows)) break;
          showFeedback("P√§iv√§n 3 tilanne on oikein: Klexane, tarvittava parasetamoli, Primperan i.v. ja Voltaren i.m., Primaspan tauolla.", true);
          ok = true;
          break;
        }
        case 3: {
          if (!checkBaseMeds(rows)) break;
          if (!checkStatinUp(rows)) break;
          if (!checkNoPlavixBurana(rows)) break;
          if (!checkPanadol(rows)) break;
          if (!checkIVandIM(rows)) break;
          if (!checkNoKlexane(rows)) break;
          if (!checkASAActive(rows)) break;
          showFeedback("P√§iv√§n 4 l√§√§kitys on oikein: Klexane on lopetettu ja Primaspan aloitettu uudelleen, muu l√§√§kitys jatkuu.", true);
          ok = true;
          break;
        }
        case 4: {
          if (!checkBaseMeds(rows)) break;
          if (!checkStatinUp(rows)) break;
          if (!checkNoPlavixBurana(rows)) break;
          if (!checkPanadol(rows)) break;
          if (!checkIVandIM(rows)) break;
          if (!checkNoKlexane(rows)) break;
          if (!checkASAActive(rows)) break;
          if (!checkCefuroxim(rows)) break;
          showFeedback("Koe valmis ‚úÖ Kaikki viiden p√§iv√§n l√§√§kitykset on merkitty oikein l√§√§kelistalle.", true);
          ok = true;
          break;
        }
        default:
          ok = false;
      }

      colorRows(rows);
      return ok;
    }

    addMedBtn.addEventListener("click", () => {
      meds.push({
        medCode: null,
        type: "Jatkuva",
        period: "",
        route: "",
        drugName: "",
        strength: "",
        form: "",
        dose: "",
        y: "", ay: "", a: "", ap: "", p: "", ip: "", i: "", iy: ""
      });
      renderMedTable();
    });

    checkBtn.addEventListener("click", () => {
      const ok = checkCurrentTask();
      lastCheckOK = ok;
      updateNextButtonVisibility();
    });

    nextBtn.addEventListener("click", () => {
      if (!lastCheckOK) return;
      if (currentTaskIndex < TASKS.length - 1) {
        currentTaskIndex++;
        lastCheckOK = false;
        feedbackEl.style.display = "none";
        renderTask();
        updateNextButtonVisibility();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    function renderHistoryInitial() {
      renderHistory();
    }

    (function init() {
      renderTask();
      renderAll();
      renderHistoryInitial();
    })();
  </script>
</body>
</html>

